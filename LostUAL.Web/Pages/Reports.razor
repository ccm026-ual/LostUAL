@page "/reports"
@attribute [Authorize(Roles = "Moderator,Admin")]
@using System.Net.Http.Json
@using LostUAL.Contracts.Reports
@using LostUAL.Web.Shared
@inject HttpClient Http
@inject NavigationManager Nav

<div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
        <h3 class="mb-1">Moderación · Reportes</h3>
        <div class="text-muted small">
            Gestiona reportes de <strong>conversaciones</strong> y <strong>posts</strong>. Haz clic en un reporte para acceder al detalle y decidir qué acción tomar
        </div>
    </div>
</div>

<div class="container py-3">

    @if (!string.IsNullOrWhiteSpace(Error))
    {
        <div class="alert alert-danger">@Error</div>
    }

    <div class="row g-4">

        <div class="col-12 col-lg-8">

            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-2 align-items-end">

                        <div class="col-12 col-md-4">
                            <label class="form-label">Estado</label>
                            <InputSelect class="form-select"
                                         @bind-Value="SelectedStatus"
                                         @bind-Value:after="OnStatusChanged"
                                         @key="SelectedStatus">
                                <option value="">Todos</option>
                                <option value="@ReportStatus.Open">Abierto</option>
                                <option value="@ReportStatus.Dismissed">Desestimado</option>
                                <option value="@ReportStatus.ActionTaken">Acción tomada</option>
                            </InputSelect>

                        </div>

                        <div class="col-12 col-md-3">
                            <label class="form-label">Tipo</label>
                            <select class="form-select" @bind="SelectedType" @bind:after="ResetPage">
                                <option value="All">Todos</option>
                                <option value="Conversation">Chat</option>
                                <option value="Post">Post</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-5">
                            <label class="form-label">Buscar</label>
                            <input class="form-control"
                                   placeholder="Motivo, reporter, bloqueado..."
                                   @bind="Q"
                                   @bind:event="oninput"
                                   @bind:after="ResetPage" />
                        </div>

                        <div class="col-12 d-flex flex-wrap gap-2 mt-2">
                            <div class="ms-auto d-flex gap-2 align-items-center">
                                <label class="text-muted small mb-0">Resultados</label>
                                <select class="form-select form-select-sm" style="max-width: 120px;"
                                        @bind="PageSize" @bind:after="ResetPage">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>

                                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearAllFilters" disabled="@IsLoading">
                                    Limpiar
                                </button>

                            </div>
                        </div>

                        <div class="col-12 text-muted small mt-2">
                            Mostrando <strong>@PagedItems.Count</strong> de <strong>@Filtered.Count</strong>.
                        </div>
                    </div>
                </div>
            </div>

            @if (Items is null)
            {
                <p>Cargando...</p>
            }
            else if (Filtered.Count == 0)
            {
                <div class="alert alert-info">No hay reportes con los filtros seleccionados.</div>
            }
            else
            {
                <div class="list-group report-list">
                    @foreach (var r in PagedItems)
                    {
                        <button type="button"
                                class="list-group-item list-group-item-action report-item @StatusClass(r.Status)"
                                @onclick="() => GoTo(r)">

                            <div class="d-flex justify-content-between align-items-start gap-2">
                                <div class="fw-semibold text-truncate" style="max-width: 75%;">
                                    @r.Reason
                                </div>

                                <div class="d-flex flex-wrap gap-2 justify-content-end">
                                    <span class="badge @(r.Type == "Conversation" ? "bg-info" : "bg-primary")">
                                        @(r.Type == "Conversation" ? "Chat" : "Post")
                                    </span>
                                    <span class="badge @StatusBadge(r.Status)">@Labels.ReportStatusLabel(r.Status)</span>
                                </div>
                            </div>

                            <div class="text-muted mt-1 small">
                                Reporter: <strong>@r.ReporterEmail</strong>
                                · @r.CreatedAtUtc.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            </div>

                            @if (r.Status == ReportStatus.ActionTaken && !string.IsNullOrWhiteSpace(r.BlockedEmail))
                            {
                                <div class="text-muted small mt-1">
                                    Bloqueado: <strong>@r.BlockedEmail</strong>
                                    @if (r.LockoutEndUtc is not null)
                                    {
                                        <span> · Hasta: @r.LockoutEndUtc.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                                    }
                                </div>
                            }
                        </button>
                    }
                </div>

                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted small">
                        Página <strong>@Page</strong> de <strong>@TotalPages</strong>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary"
                                @onclick="PrevPage"
                                disabled="@(Page <= 1)">
                            Anterior
                        </button>

                        <button class="btn btn-sm btn-outline-secondary"
                                @onclick="NextPage"
                                disabled="@(Page >= TotalPages)">
                            Siguiente
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="col-12 col-lg-4">
            <div class="sticky-top" style="top: 1rem;">

                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="mb-3">Resumen</h5>

                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Total cargados</span>
                            <strong>@(Items?.Count ?? 0)</strong>
                        </div>

                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Abiertos</span>
                            <strong>@(Items?.Count(x => x.Status == ReportStatus.Open) ?? 0)</strong>
                        </div>

                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Desestimados</span>
                            <strong>@(Items?.Count(x => x.Status == ReportStatus.Dismissed) ?? 0)</strong>
                        </div>

                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Acción tomada</span>
                            <strong>@(Items?.Count(x => x.Status == ReportStatus.ActionTaken) ?? 0)</strong>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Chat</span>
                            <strong>@(Items?.Count(x => x.Type == "Conversation") ?? 0)</strong>
                        </div>

                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Post</span>
                            <strong>@(Items?.Count(x => x.Type == "Post") ?? 0)</strong>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

@code {
    private List<ModerationRow>? Items;
    private string? Error;
    private bool IsLoading;

    private ReportStatus? SelectedStatus;

    private string SelectedType = "All";
    private string Q = "";

    private int Page = 1;
    private int PageSize = 10;

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        Error = null;
        IsLoading = true;

        try
        {
            var convUrl = "api/moderation/conversations/reports";
            var postUrl = "api/moderation/posts/reports";

            if (SelectedStatus is not null)
            {
                convUrl += $"?status={SelectedStatus}";
                postUrl += $"?status={SelectedStatus}";
            }

            var conv = await Http.GetFromJsonAsync<List<ConversationReportListItemDto>>(convUrl) ?? new();
            var posts = await Http.GetFromJsonAsync<List<PostReportListItemDto>>(postUrl) ?? new();

            Items = conv.Select(r => new ModerationRow
                {
                    Type = "Conversation",
                    ReportId = r.Id,
                    TargetId = r.ConversationId,
                    CreatedAtUtc = r.CreatedAtUtc,
                    Status = r.Status,
                    Reason = r.Reason,
                    ReporterEmail = r.ReporterEmail,
                    BlockedEmail = r.BlockedEmail,
                    LockoutEndUtc = r.LockoutEndUtc
                })
                .Concat(posts.Select(r => new ModerationRow
                {
                    Type = "Post",
                    ReportId = r.Id,
                    TargetId = r.PostId,
                    CreatedAtUtc = r.CreatedAtUtc,
                    Status = r.Status,
                    Reason = r.Reason,
                    ReporterEmail = r.ReporterEmail,
                    BlockedEmail = r.BlockedEmail,
                    LockoutEndUtc = r.LockoutEndUtc
                }))
                .OrderByDescending(x => x.CreatedAtUtc)
                .ToList();

            ResetPage();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
            Items = new();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void GoTo(ModerationRow r)
    {
        if (r.Type == "Conversation")
        {
            Nav.NavigateTo($"/conversations/{r.TargetId}?reportId={r.ReportId}");
            return;
        }

        Nav.NavigateTo($"/posts/{r.TargetId}?postReportId={r.ReportId}");
    }

    private void QuickStatus(ReportStatus? s)
    {
        SelectedStatus = s;
        _ = LoadAsync();
    }

    private void ResetPage() => Page = 1;

    private void PrevPage() { if (Page > 1) Page--; }

    private void NextPage() { if (Page < TotalPages) Page++; }

    private async Task ClearAllFilters()
    {
        SelectedStatus = null;  
        SelectedType = "All";
        Q = "";
        PageSize = 10;         
        ResetPage();
        await LoadAsync();       
    }


    private List<ModerationRow> Filtered
    {
        get
        {
            var src = Items ?? new();

            if (SelectedType != "All")
                src = src.Where(x => x.Type == SelectedType).ToList();

            var q = (Q ?? "").Trim();
            if (q.Length > 0)
            {
                src = src.Where(x =>
                        (x.Reason?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false)
                        || (x.ReporterEmail?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false)
                        || (x.BlockedEmail?.Contains(q, StringComparison.OrdinalIgnoreCase) ?? false)
                    )
                    .ToList();
            }

            return src;
        }
    }

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(Filtered.Count / (double)PageSize));

    private List<ModerationRow> PagedItems =>
        Filtered
            .Skip((Page - 1) * PageSize)
            .Take(PageSize)
            .ToList();

    private static string StatusBadge(ReportStatus s) => s switch
    {
        ReportStatus.Open => "bg-warning text-dark",
        ReportStatus.Dismissed => "bg-secondary",
        ReportStatus.ActionTaken => "bg-danger",
        _ => "bg-light text-dark"
    };

    private static string StatusClass(ReportStatus s) => s switch
    {
        ReportStatus.Open => "is-open",
        ReportStatus.ActionTaken => "is-action",
        ReportStatus.Dismissed => "is-dismissed",
        _ => ""
    };

    private async Task OnStatusChanged()
    {
        ResetPage();
        await LoadAsync();
    }


    private sealed class ModerationRow
    {
        public string Type { get; set; } = "";
        public int ReportId { get; set; }
        public int TargetId { get; set; }

        public DateTime CreatedAtUtc { get; set; }
        public ReportStatus Status { get; set; }

        public string Reason { get; set; } = "";
        public string ReporterEmail { get; set; } = "";

        public string? BlockedEmail { get; set; }
        public DateTime? LockoutEndUtc { get; set; }
    }
}
