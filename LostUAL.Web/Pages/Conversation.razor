@page "/conversations/{ConversationId:int}"
@attribute [Authorize]

@using System.Net.Http.Json
@using LostUAL.Contracts.Chat
@using LostUAL.Contracts.Claims
@using LostUAL.Web.Shared
@using Microsoft.AspNetCore.WebUtilities
@using System.Security.Claims
@using System.IdentityModel.Tokens.Jwt;
@inject NavigationManager Nav
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JS

<div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
    <div>
        <h3 class="mb-1">Chat</h3>
        <div class="text-muted small">
            Recuerda mantener el respeto
        </div>
    </div>
</div>

@if (_loading)
{
    <p>Cargando...</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
else
{
    <div class="container py-3">

        <div class="d-flex flex-wrap justify-content-between align-items-start gap-2 mb-3">
            <div>
                <div class="text-muted small">
                    @if (IsModerationView && Report is not null)
                    {
                        <span>  Vista moderación · Denunciante: <strong>@Report.ReporterEmail</strong></span>
                    }
                </div>
            </div>

            <div class="d-flex flex-wrap gap-2 align-items-center">
                <span class="badge bg-secondary">Reclamación: @Labels.ClaimStatusLabel(_claimStatus)</span>

                <span class="badge @(_status == ConversationStatus.ReadOnly ? "bg-warning text-dark" : "bg-success")">
                    @(_status == ConversationStatus.ReadOnly ? "Solo lectura" : "Activa")
                </span>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert alert-danger">@_error</div>
        }

        <div class="row g-4">

            <div class="col-12 col-lg-8">

                @if (_status == ConversationStatus.ReadOnly)
                {
                    <div class="alert alert-warning">
                        Este chat está en modo solo lectura.
                    </div>
                }

                <div class="chat-card mb-3">
                    <div class="chat-messages" @ref="_chatMessagesRef">
                        @if (_messages.Count == 0)
                        {
                            <div class="text-muted">No hay mensajes todavía.</div>
                        }
                        else
                        {
                            @foreach (var m in _messages)
                            {
                                var mine = IsMine(m);

                                <div class="msg-row @(mine ? "mine" : "theirs")">
                                    <div class="msg-bubble">
                                        <div class="msg-meta @(mine ? "text-end" : "")">
                                            <span class="msg-sender">@((mine) ? "Tú" : (m.SenderEmail ?? "Usuario"))</span>
                                            <span class="msg-time">@m.CreatedAtUtc.ToLocalTime().ToString("dd/MM HH:mm")</span>
                                        </div>

                                        <div class="msg-text">@m.Body</div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
                @if(!IsModerationView){
                <div class="card">
                    <div class="card-body">
                        <EditForm Model="_send" OnValidSubmit="SendAsync">
                            <div class="input-group">
                                <InputText class="form-control" @bind-Value="_send.Body" placeholder="Escribe un mensaje..." />
                                <button class="btn btn-primary" type="submit" disabled="@(_sending || _status == ConversationStatus.ReadOnly)">
                                    @(_sending ? "Enviando..." : "Enviar")
                                </button>
                            </div>
                        </EditForm>

                        @if (!string.IsNullOrWhiteSpace(_sendError))
                        {
                            <div class="alert alert-danger mt-2 mb-0">@_sendError</div>
                        }
                    </div>
                </div>
                }
            </div>

            <div class="col-12 col-lg-4">
                <div class="sticky-top" style="top: 1rem;">

                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="mb-3">Acciones</h5>

                            @if (_claimStatus == ClaimStatus.Accepted)
                            {
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-info text-dark">
                                        Dueño: @(_ownerConfirmedAtUtc is null ? "pendiente" : "confirmado")
                                    </span>
                                    <span class="badge bg-info text-dark">
                                        Demandante: @(_claimantConfirmedAtUtc is null ? "pendiente" : "confirmado")
                                    </span>
                                </div>

                                @if (_autoResolveAtUtc is not null)
                                {
                                    <div class="small text-muted mb-2">
                                        Auto-resolución: @_autoResolveAtUtc.Value.ToLocalTime()
                                    </div>
                                }
                            }

                            @if (!string.IsNullOrWhiteSpace(_actionError))
                            {
                                <div class="alert alert-danger">@_actionError</div>
                            }

                            <div class="d-grid gap-2">
                                @if (_canAccept)
                                {
                                    <button class="btn btn-success btn-sm" @onclick="AcceptAsync" disabled="@_acting">
                                        @(_acting ? "Procesando..." : "Aceptar")
                                    </button>
                                }

                                @if (_canReject)
                                {
                                    <button class="btn btn-danger btn-sm" @onclick="RejectAsync" disabled="@_acting">
                                        @(_acting ? "Procesando..." : "Rechazar")
                                    </button>
                                }

                                @if (_canConfirm)
                                {
                                    <button class="btn btn-primary btn-sm" @onclick="ConfirmAsync" disabled="@_acting">
                                        @(_acting ? "Procesando..." : "Confirmar resolución")
                                    </button>
                                }

                                @if (_canWithdraw)
                                {
                                    <button class="btn btn-danger btn-sm" @onclick="WithdrawAsync" disabled="@_acting">
                                        @(_acting ? "Procesando..." : "Retirar reclamación")
                                    </button>
                                }
                            </div>

                            <hr class="my-3" />
                            @if (!IsModerationView){
                                    <button class="btn btn-danger w-100 btn-sm" @onclick="() => ShowReport = true">
                                        Reportar chat
                                    </button>
                            }
                        </div>
                    </div>

                    @if (IsModerationView)
                    {
                        <div class="card border-warning">
                            <div class="card-body">
                                <h5 class="text-center mb-2">Moderación</h5>
                                <hr class="my-2" />

                                @if (!string.IsNullOrWhiteSpace(ModError))
                                {
                                    <div class="alert alert-danger">@ModError</div>
                                }

                                @if (Report is not null)
                                {
                                    <div>Reporte: @Report.Reason</div>
                                    <div class="text-muted small">
                                        Estado: <strong>@Labels.ReportStatusLabel(Report.Status)</strong>
                                    </div>
                                    <div class="text-muted small">
                                        Denunciante: <strong>@Report.ReporterEmail</strong>
                                    </div>

                                    @if (Report.Status == ReportStatus.ActionTaken && !string.IsNullOrWhiteSpace(Report.BlockedEmail))
                                    {
                                        <div class="text-muted small mt-1">
                                            Usuario bloqueado: <strong>@Report.BlockedEmail</strong>
                       
                                        </div>
                                        @if (Report.LockoutEndUtc is not null)
                                        {
                                            <div class="text-muted small">
                                                Hasta: <strong>@Report.LockoutEndUtc.Value.ToLocalTime()</strong>
                                            </div>
                                        }
                                    }
                                }

                                @if (Report?.Status == ReportStatus.Open)
                                {
                                    <hr class="my-3" />

                                    <div class="row g-2">
                                        <button type="button"
                                                class="btn btn-secondary btn-sm"
                                                disabled="@(ModBusy)"
                                                @onclick="DismissReport">
                                            Desestimar
                                        </button>
                                        <div class="col-4">
                                            <label class="form-label small mb-1">Días de bloq.</label>
                                            <input class="form-control" type="number" min="1" @bind="BlockDays" />
                                        </div>
                                        <div class="col-8">
                                            <label class="form-label small mb-1">Nota</label>
                                            <input class="form-control" placeholder="Nota (opcional)" @bind="ModNote" />
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 mt-2">
                               

                                        <button type="button"
                                                class="btn btn-danger btn-sm"
                                                disabled="@(ModBusy)"
                                                @onclick="BlockUserFromReport">
                                            Bloquear usuario
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    }
            </div>
        </div>
    </div>

        <ReportConversationModal ConversationId="@ConversationId"
                                 Visible="@ShowReport"
                                 VisibleChanged="@((bool v) => ShowReport = v)" />
    </div>
    }

@code {
    private bool ShowReport;
    [Parameter] public int ConversationId { get; set; }

    private string? _myEmail;

    private bool _loading = true;
    private bool _sending;
    private string? _error;
    private string? _sendError;
    private int _claimId;
    private ClaimStatus _claimStatus = ClaimStatus.Pending;
    private bool _canAccept;
    private bool _canReject;
    private bool _canConfirm;
    private bool _canWithdraw;

    private DateTime? _ownerConfirmedAtUtc;
    private DateTime? _claimantConfirmedAtUtc;
    private DateTime? _autoResolveAtUtc;

    private bool _acting;
    private string? _actionError;

    private ConversationStatus _status = ConversationStatus.Active;
    private List<MessageDto> _messages = new();
    private SendDto _send = new();

    private ElementReference _chatMessagesRef;
    private bool _scrollToBottomPending;

    //MODERACIÓN

    private int? ReportId;
    private ConversationReportSummaryDto? Report;
    private bool IsModerationView => ReportId is not null;

    private string? ModError;
    private bool ModBusy;
    private int BlockDays = 7;
    private string? ModNote;


    protected override async Task OnParametersSetAsync()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var q = QueryHelpers.ParseQuery(uri.Query);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _myEmail = user.FindFirst(ClaimTypes.Email)?.Value;

        ReportId = null;
        if (q.TryGetValue("reportId", out var rid) && int.TryParse(rid.ToString(), out var parsed))
            ReportId = parsed;

        if (ReportId is not null) 
        { 
            await LoadReportSummaryAsync(ReportId.Value);
            _myEmail = Report?.ReporterEmail; 
        }

        else
            Report = null;

            await LoadAsync();

        }

    private bool IsMine(MessageDto m)
    {
        if (string.IsNullOrWhiteSpace(_myEmail)) return false;
        return string.Equals(m.SenderEmail, _myEmail, StringComparison.OrdinalIgnoreCase);
    }

    private async Task LoadAsync()
    {
        _loading = true;
        _error = null;

        try
        {
            var resp = await Http.GetFromJsonAsync<GetMessagesResponse>($"/api/conversations/{ConversationId}/messages");
            if (resp is null)
            {
                _error = "Respuesta inválida del servidor.";
                return;
            }

            _status = resp.Status;
            _messages = resp.Messages ?? new();
            _claimId = resp.ClaimId;
            _claimStatus = resp.ClaimStatus;
            _canAccept = resp.CanAccept;
            _canReject = resp.CanReject;
            _canConfirm = resp.CanConfirm;
            _canWithdraw = resp.CanWithdraw;
            _ownerConfirmedAtUtc = resp.OwnerConfirmedAtUtc;
            _claimantConfirmedAtUtc = resp.ClaimantConfirmedAtUtc;
            _autoResolveAtUtc = resp.AutoResolveAtUtc;

        }
        catch (HttpRequestException ex)
        {
            _error = ex.Message;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _scrollToBottomPending = true;
            _loading = false;
        }
    }

    private async Task SendAsync()
    {
        _sendError = null;

        var text = (_send.Body ?? "").Trim();
        if (text.Length == 0)
        {
            _sendError = "Mensaje vacío.";
            return;
        }

        _sending = true;

        try
        {
            var resp = await Http.PostAsJsonAsync($"/api/conversations/{ConversationId}/messages", new { body = text });

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                _sendError = string.IsNullOrWhiteSpace(body) ? $"Error {(int)resp.StatusCode}" : body;
                return;
            }

            _send = new SendDto(); 
            await LoadAsync();     
        }
        catch (Exception ex)
        {
            _sendError = ex.Message;
        }
        finally
        {
            _sending = false;
        }
    }

    private static string ShortUser(string s) => s.Length <= 8 ? s : s[..8];

    private sealed class GetMessagesResponse
    {
        public int ConversationId { get; set; }
        public ConversationStatus Status { get; set; }

        public int ClaimId { get; set; }
        public ClaimStatus ClaimStatus { get; set; }
        public bool CanAccept { get; set; }
        public bool CanReject { get; set; }
        public bool CanWithdraw { get; set; }

        public bool CanConfirm { get; set; }
        public DateTime? OwnerConfirmedAtUtc { get; set; }
        public DateTime? ClaimantConfirmedAtUtc { get; set; }
        public DateTime? AutoResolveAtUtc { get; set; }


        public List<MessageDto>? Messages { get; set; }
    }

    private async Task AcceptAsync()
    {
        _actionError = null;
        _acting = true;

        try
        {
            var resp = await Http.PostAsync($"/api/claims/{_claimId}/accept", null);

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                _actionError = string.IsNullOrWhiteSpace(body) ? $"Error {(int)resp.StatusCode}" : body;
                return;
            }

            await LoadAsync();
        }
        finally
        {
            _acting = false;
        }
    }

    private async Task RejectAsync()
    {
        _actionError = null;
        _acting = true;

        try
        {
            var resp = await Http.PostAsync($"/api/claims/{_claimId}/reject", null);

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                _actionError = string.IsNullOrWhiteSpace(body) ? $"Error {(int)resp.StatusCode}" : body;
                return;
            }

            await LoadAsync();
        }
        finally
        {
            _acting = false;
        }
    }

    private async Task WithdrawAsync()
    {
        _actionError = null;
        _acting = true;

        try
        {
            var resp = await Http.PostAsync($"/api/claims/{_claimId}/withdraw", null);

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                _actionError = string.IsNullOrWhiteSpace(body) ? $"Error {(int)resp.StatusCode}" : body;
                return;
            }

            await LoadAsync();
        }
        finally
        {
            _acting = false;
        }
    }


    private async Task ConfirmAsync()
    {
        _actionError = null;
        _acting = true;

        try
        {
            var resp = await Http.PostAsync($"/api/claims/{_claimId}/confirm", null);

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                _actionError = string.IsNullOrWhiteSpace(body) ? $"Error {(int)resp.StatusCode}" : body;
                return;
            }

            await LoadAsync();
        }
        finally
        {
            _acting = false;
        }
    }

    private async Task LoadReportSummaryAsync(int reportId)
    {
        ModError = null;

        try
        {
            Report = await Http.GetFromJsonAsync<ConversationReportSummaryDto>(
                $"api/moderation/conversations/reports/{reportId}/summary");
        }
        catch (Exception ex)
        {
            ModError = ex.Message;
        }
    }

    private async Task DismissReport()
    {
        if (ReportId is null) return;

        ModBusy = true;
        ModError = null;

        try
        {
            var res = await Http.PostAsJsonAsync(
                $"api/moderation/conversations/reports/{ReportId.Value}/dismiss",
                new { note = ModNote });

            if (!res.IsSuccessStatusCode)
            {
                ModError = await res.Content.ReadAsStringAsync();
                return;
            }

            await LoadReportSummaryAsync(ReportId.Value);
        }
        catch (Exception ex)
        {
            ModError = ex.Message;
        }
        finally
        {
            ModBusy = false;
        }
        @*ModError = "CLICK DismissReport() OK";
        StateHasChanged();*@
    }

    private async Task BlockUserFromReport()
    {
        if (ReportId is null) return;

        ModBusy = true;
        ModError = null;

        try
        {
            var res = await Http.PostAsJsonAsync(
                $"api/moderation/conversations/reports/{ReportId.Value}/block",
                new { days = BlockDays, note = ModNote });

            if (!res.IsSuccessStatusCode)
            {
                ModError = await res.Content.ReadAsStringAsync();
                return;
            }

            await LoadReportSummaryAsync(ReportId.Value);
        }
        catch (Exception ex)
        {
            ModError = ex.Message;
        }
        finally
        {
            ModBusy = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_scrollToBottomPending)
        {
            _scrollToBottomPending = false;
            await JS.InvokeVoidAsync("lostualScrollToBottom", _chatMessagesRef);
        }
    }


}


